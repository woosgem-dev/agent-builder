generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(cuid())
  githubId  String     @unique @map("github_id")
  username  String     @unique
  email     String?
  avatarUrl String?    @map("avatar_url")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  bookmarks Bookmark[]
  installs  Install[]
  reviews   Review[]
  skills    Skill[]

  @@map("users")
}

model Skill {
  id           String        @id @default(cuid())
  name         String
  description  String
  version      String
  authorId     String        @map("author_id")
  sourceType   String        @default("github") @map("source_type")
  sourceOwner  String        @map("source_owner")
  sourceRepo   String        @map("source_repo")
  sourcePath   String        @map("source_path")
  sourceRef    String        @default("main") @map("source_ref")
  minModel     String?       @map("min_model")
  baseTokens   Int?          @map("base_tokens")
  contextHint  String?       @map("context_hint")
  icon         String?
  license      String?
  status       SkillStatus   @default(PENDING)
  deletedAt    DateTime?     @map("deleted_at")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  bookmarks    Bookmark[]
  installs     Install[]
  qualityScore QualityScore?
  reviews      Review[]
  tags         SkillTag[]
  tools        SkillTool[]
  author       User          @relation(fields: [authorId], references: [id])
  targetRoles  TargetRole[]
  useCases     UseCase[]

  @@unique([authorId, name])
  @@unique([sourceOwner, sourceRepo, sourcePath])
  @@index([status])
  @@index([authorId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("skills")
}

model Tag {
  id     String     @id @default(cuid())
  name   String     @unique
  skills SkillTag[]

  @@map("tags")
}

model SkillTag {
  skillId String @map("skill_id")
  tagId   String @map("tag_id")
  skill   Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id])

  @@id([skillId, tagId])
  @@index([tagId])
  @@map("skill_tags")
}

model Tool {
  id         String      @id @default(cuid())
  name       String      @unique
  skillTools SkillTool[]

  @@map("tools")
}

model SkillTool {
  skillId  String  @map("skill_id")
  toolId   String  @map("tool_id")
  required Boolean @default(true)
  skill    Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)
  tool     Tool    @relation(fields: [toolId], references: [id])

  @@id([skillId, toolId])
  @@map("skill_tools")
}

model UseCase {
  id      String @id @default(cuid())
  skillId String @map("skill_id")
  content String
  skill   Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@map("use_cases")
}

model TargetRole {
  id      String @id @default(cuid())
  skillId String @map("skill_id")
  role    String
  skill   Skill  @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@map("target_roles")
}

model QualityScore {
  id                String   @id @default(cuid())
  skillId           String   @unique @map("skill_id")
  coreFieldScore    Int      @map("core_field_score")
  descriptionScore  Int      @map("description_score")
  runtimeScore      Int      @map("runtime_score")
  resourcesScore    Int      @map("resources_score")
  useCasesScore     Int      @map("use_cases_score")
  dependenciesScore Int      @map("dependencies_score")
  totalScore        Int      @map("total_score")
  grade             Grade
  analysisComment   String?  @map("analysis_comment")
  improvementTips   String[] @map("improvement_tips")
  analyzedAt        DateTime @default(now()) @map("analyzed_at")
  skill             Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([totalScore])
  @@index([grade])
  @@map("quality_scores")
}

model Review {
  id        String   @id @default(cuid())
  skillId   String   @map("skill_id")
  authorId  String   @map("author_id")
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  author    User     @relation(fields: [authorId], references: [id])
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([skillId, authorId])
  @@index([skillId])
  @@index([createdAt])
  @@map("reviews")
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  skillId   String   @map("skill_id")
  createdAt DateTime @default(now()) @map("created_at")
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId])
  @@map("bookmarks")
}

model Install {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  skillId   String   @map("skill_id")
  createdAt DateTime @default(now()) @map("created_at")
  skill     Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@index([userId])
  @@index([skillId])
  @@map("installs")
}

enum SkillStatus {
  PENDING
  ACTIVE
  DEPRECATED
  ARCHIVED
}

enum Grade {
  S
  A
  B
  C
  D
}
